# render.yaml - Add this file to your repository root
# This tells Render how to deploy your app

services:
  # Main web service
  - type: web
    name: whatsapp-assistant-api
    env: python
    region: oregon  # Choose closest to your users
    plan: starter  # or free (has limitations)
    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn app:app --host 0.0.0.0 --port $PORT --workers 2
    
    envVars:
      # Environment variables (set these in Render dashboard)
      - key: PYTHON_VERSION
        value: 3.11.0
      
      - key: API_KEY
        sync: false  # Manual input in dashboard
      
      - key: POSTGRES_URI
        sync: false  # Manual input in dashboard
      
      - key: POSTGRES_URI_POOLER
        sync: false  # Manual input in dashboard
      
      # Important: Tell Render this app needs longer startup
      - key: RENDER_EXTERNAL_TIMEOUT
        value: 300  # 5 minutes for health check
    
    # Health check endpoint (Render pings this)
    healthCheckPath: /health
    
    # Auto-deploy on git push
    autoDeploy: true
    
    # Disk storage for uploads (persistent)
    disk:
      name: uploads
      mountPath: /opt/render/project/src/knowledge_base_uploads
      sizeGB: 10  # 10GB for document storage


# ============================================================================
# IMPORTANT RENDER SETTINGS (Configure in Render Dashboard)
# ============================================================================

# 1. Build Command:
#    pip install -r requirements.txt

# 2. Start Command:
#    uvicorn app:app --host 0.0.0.0 --port $PORT --workers 2 --timeout-keep-alive 300

# 3. Health Check:
#    Path: /health
#    Initial Delay: 60 seconds (give time for first startup)

# 4. Environment Variables (add in Render dashboard):
#    - API_KEY=your_groq_api_key
#    - POSTGRES_URI=postgresql://user:pass@host:5432/db
#    - POSTGRES_URI_POOLER=postgresql://user:pass@host:6543/db?pgbouncer=true

# ============================================================================
# RENDER TIMEOUT LIMITS (Important!)
# ============================================================================
"""
Render Plan Limits:

FREE TIER:
- HTTP Request timeout: 30 seconds (STRICT)
- Deployment timeout: 15 minutes
- Will spin down after 15 min inactivity
- 750 hours/month

STARTER ($7/month):
- HTTP Request timeout: 120 seconds (STRICT)
- Deployment timeout: 30 minutes
- Always on (no spin down)
- Unlimited hours

STANDARD ($25/month):
- HTTP Request timeout: 300 seconds
- Deployment timeout: 60 minutes
- Always on
- Unlimited hours

YOUR PROBLEM:
- Your RAG initialization takes 14 minutes
- Render's HTTP timeout is max 120 seconds (Starter) or 30 seconds (Free)
- Solution: Return response IMMEDIATELY, process in background thread
"""

# ============================================================================
# UPDATED requirements.txt (Make sure these versions work)
# ============================================================================
"""
# Core
fastapi==0.115.5
uvicorn[standard]==0.32.1
python-multipart==0.0.18
pydantic==2.10.3
pydantic-settings==2.6.1

# Database
asyncpg==0.30.0
psycopg[binary,pool]==3.2.3
psycopg-pool==3.2.4
sqlalchemy==2.0.36

# LangChain & AI
langchain==0.3.13
langchain-community==0.3.13
langchain-core==0.3.28
langchain-postgres==0.0.13
langchain-huggingface==0.1.2
langchain-groq==0.2.1
langchain-text-splitters==0.3.4
langgraph==0.2.62
langgraph-checkpoint==2.0.10

# Embeddings & Vector Store
sentence-transformers==3.3.1
huggingface-hub==0.27.0

# Document Processing
pypdf==5.1.0
python-docx==1.1.2
openpyxl==3.1.5

# Utilities
python-dotenv==1.0.1
httpx==0.28.1
aiohttp==3.11.11
requests==2.32.3
tenacity==9.0.0
trustcall==0.2.1

# File monitoring (optional - can remove if issues)
# watchdog==6.0.0
"""

# ============================================================================
# Procfile (Alternative to render.yaml - simpler)
# ============================================================================
"""
# Create a file named "Procfile" (no extension) with:
web: uvicorn app:app --host 0.0.0.0 --port $PORT --workers 2 --timeout-keep-alive 300
"""

# ============================================================================
# .dockerignore (if using Docker)
# ============================================================================
"""
__pycache__/
*.pyc
*.pyo
*.pyd
.Python
env/
venv/
.env
.venv
*.log
.git/
.gitignore
README.md
tests/
.pytest_cache/
knowledge_base_uploads/
*.csv
*.pdf
*.docx
"""

# ============================================================================
# Key Changes Summary for Render Deployment
# ============================================================================
"""
1. UPLOAD ENDPOINT:
   ✅ Return response in < 5 seconds
   ✅ Use ThreadPoolExecutor for true background processing
   ✅ Store status in database

2. STATUS ENDPOINT:
   ✅ Allow clients to poll for completion
   ✅ Show elapsed time and estimated remaining

3. CHAT ENDPOINT:
   ✅ Check if RAG is ready
   ✅ Return helpful message if still processing

4. RENDER CONFIG:
   ✅ Set appropriate timeouts
   ✅ Use persistent disk for uploads
   ✅ Configure health checks

5. DATABASE:
   ✅ Add rag_status table
   ✅ Track processing state
   ✅ Survives deployments/restarts
"""